# 内部仕様書: イベント管理システム

## 概要

本文書は、サークル内利用を想定したイベント管理システムの完全版内部仕様を定義するものです。ドメインモデルとアーキテクチャ原則に基づき、バックエンドからフロントエンドに至るまで、システムの全階層にわたる詳細な設計図と具体的な実装ブループリントを提供します。

## 第 1 部: ドメイン駆動設計：コアビジネスロジック

本セクションでは、システムの概念的基盤を確立します。厳格なユビキタス言語を定義し、リッチで振る舞いを持つ集約を用いてドメインをモデリングします。

### 1.1. ユビキタス言語

本プロジェクトにおいて、開発者とコードの間で共有される共通言語を以下のように定義します。

#### 表 1.1: ユビキタス言語の用語集

| 用語           | 英語表記          | 説明                                                                                                                        |
| -------------- | ----------------- | --------------------------------------------------------------------------------------------------------------------------- |
| ユーザー       | User              | システムを利用するすべての人。認証は外部で行われ、役割(Role)と世代(Generation)を持つ。User オブジェクトとしてモデル化。     |
| イベント       | Event             | システムが管理する中心的な対象物（例会、合宿など）。Event 集約としてモデル化される。                                        |
| 主催者         | Organizer         | イベントを作成・管理するユーザー。特定の Event オブジェクトの属性として記録される機能的な役割であり、固定の Role ではない。 |
| 参加登録       | Registration      | あるユーザーが、あるイベントに参加することを示す関係性。Registration 集約としてモデル化される。                             |
| 日程調整       | SchedulePoll      | イベントの日時を決めるための機能。Event 集約内部のエンティティとしてモデル化される。                                        |
| 料金設定       | FeeSetting        | 特定の役割・世代に対する料金ルール。Event 集約内部のエンティティとしてモデル化される。                                      |
| 集約           | Aggregate         | 一貫性の境界を定義する DDD の構成要素。トランザクションの単位。例：Event 集約。                                             |
| エンティティ   | Entity            | 集約の内部に存在し、一意な識別子を持つオブジェクト。例：FeeSetting エンティティ。                                           |
| 値オブジェクト | Value Object (VO) | 属性値によって定義される不変のオブジェクト。例：Money, EventStatus。                                                        |
| コマンド       | Command           | システムの状態を変更する意図を表すオブジェクト。例：CreateEventCommand。                                                    |
| クエリ         | Query             | システムの状態を変更せず、データを取得するための操作。例：GetEventDetailsQuery。                                            |
| 不変条件       | Invariant         | 集約が常に維持しなければならないビジネスルール。                                                                            |

### 1.2. ドメインモデル：集約、エンティティ、値オブジェクト

ここまでの対話で確定した、本システム固有のドメインモデルを以下に示します。

#### User オブジェクト

**説明**: システムを利用するすべての人。認証は外部サービスで行います。ユーザーの Role と Generation が、イベントへの参加資格や料金を決定する際の重要な情報となります。

**属性**:

- UserID (外部サービスから連携される ID)
- Name (名前)
- Role (役割: CircleAdmin, RegularMember, Alumni, External など)
- Generation (世代: "2023", "2024" など。文字列型)

**振る舞い**: なし (ユーザー情報は外部で管理)

#### Event 集約 (Aggregate)

**説明**: システムで管理される中心的な集約ルート。このオブジェクトが、イベントに関するすべての情報とビジネスルールを保持します。

**属性**:

- EventID (UUID): 集約の一意な識別子。
- Organizer (User Reference): このイベントを作成した User への参照。
- Title (string): イベント名。
- Description (string): 詳細な説明。
- Status (EventStatus VO): イベントのライフサイクル状態。
- AllowedRoles (Role[]): 参加を許可する役割のリスト。
- Tags (Tag[]): タグのリスト。
- Venue (string): 会場情報。
- SchedulePoll (SchedulePoll Entity): 日程調整情報。
- FeeSettings (FeeSetting[]): 料金設定のリスト。
- Comments (Comment[]): コメントのリスト。
- EventReports (EventReport[]): イベント記録のリスト。

**振る舞い**:

- CreateDraft(): 下書きイベントを作成する。
- UpdateDetails(): イベント情報を編集する。
- StartSchedulePolling(): 日程調整を開始する。
- ConfirmSchedule(finalDate): 開催日時を確定する。
- Publish(): 参加者募集を開始する。
- Cancel(): イベントをキャンセルする。
- Finish(): イベントを終了済みにする。
- AddComment(): コメントを追加する。
- GetApplicableFee(user): 特定のユーザーに適用される料金を決定して返す。

#### Registration 集約 (Aggregate)

**説明**: あるユーザーが、あるイベントに参加することを示す関係性。どの料金が適用されたかも記録します。

**属性**:

- RegistrationID (UUID): 集約の一意な識別子。
- Event (Event Reference): 参加するイベントへの参照。
- User (User Reference): 参加するユーザーへの参照。
- Status (RegistrationStatus VO): 登録状態 (REGISTERED, CANCELLED)。
- AppliedFee (Money VO): 適用された料金。

**振る舞い**:

- Cancel(): 参加登録をキャンセルする。

#### コアエンティティ（Event 集約内部）

- **SchedulePoll エンティティ**: 日程調整機能。
  - 状態: PollType, CandidateDates, Responses, FinalizedDate。
- **FeeSetting エンティティ**: 役割・世代ごとの料金ルール。
  - 状態: ApplicableRole, ApplicableGeneration, Fee (Money VO)。

#### コア値オブジェクト (Value Objects)

- **EventStatus**: イベントのライフサイクルを表す列挙型 (DRAFT, SCHEDULE_POLLING, CONFIRMED, FINISHED, CANCELLED)。
- **Money**: 金額と通貨を扱うオブジェクト。

### 1.3. 集約の不変条件

集約が常に一貫した状態を保つために強制しなければならないビジネスルールです。

#### 表 1.2: 集約の不変条件

| 集約         | 不変条件                                                                             | ビジネス上の正当性                                                       |
| ------------ | ------------------------------------------------------------------------------------ | ------------------------------------------------------------------------ |
| Event        | 公開（Publish）時、日程調整が完了し、開催日時が確定していなければならない。          | 開催日時未定のイベントで参加者を募集する混乱を防ぐため。                 |
| Event        | 公開時、イベントの開始日は過去であってはならない。                                   | 過去のイベントを公開することは無意味であるため。                         |
| Event        | 一度キャンセルされたイベントは、再度公開することはできない。                         | キャンセルされたイベントが誤って再開されることによる混乱を防ぐため。     |
| Event        | 日程調整の回答は、許可された役割(AllowedRoles)を持つユーザーのみ行える。             | イベントに参加資格のないユーザーが日程調整に影響を与えることを防ぐため。 |
| Registration | イベントへの参加登録は、Event の AllowedRoles に含まれる役割を持つ User のみ行える。 | イベントの参加対象者を制限するため。                                     |

## 第 2 部: システムユースケース：CQRS 実装

### 2.1. コマンドモデル（書き込み操作）

#### 表 2.1: コマンド仕様

| コマンド名         | 英語表記                  | 説明                                                           | パラメータ                                                                                                        | 対象集約            |
| ------------------ | ------------------------- | -------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------- | ------------------- |
| イベント作成       | CreateEventCommand        | 新しいイベントを作成し、日程調整を開始する。                   | { Title, Description, Venue, AllowedRoles, Tags, FeeSettings, PollCandidates } (主催者 UserID は認証情報から取得) | Event               |
| イベント情報更新   | UpdateEventDetailsCommand | 既存のイベントの基本情報（名称、説明、料金設定等）を更新する。 | { EventID, Title, Description, ... }                                                                              | Event               |
| イベント公開       | PublishEventCommand       | 日程確定済みのイベントを公開し、参加登録を受け付け可能にする。 | { EventID }                                                                                                       | Event               |
| イベントキャンセル | CancelEventCommand        | 公開中のイベントをキャンセルする。                             | { EventID, Reason }                                                                                               | Event               |
| 日程調整回答       | RespondToPollCommand      | ユーザーが日程調整の候補日に回答する。                         | { EventID, Responses } (UserID は認証情報から取得)                                                                | Event               |
| 日程確定           | FinalizeScheduleCommand   | 主催者がイベントの開催日時を最終決定する。                     | { EventID, FinalizedDate }                                                                                        | Event               |
| イベント参加登録   | RegisterForEventCommand   | ユーザーがイベントに参加登録する。                             | { EventID } (UserID は認証情報から取得)                                                                           | Registration, Event |
| 参加登録キャンセル | CancelRegistrationCommand | ユーザーがイベントへの登録をキャンセルする。                   | { RegistrationID }                                                                                                | Registration, Event |

### 2.2. クエリモデル（読み取り操作）

#### 表 2.2: クエリおよび DTO 仕様

| クエリ名             | 英語表記             | 説明                                                       | パラメータ                                  | 返却 DTO                         |
| -------------------- | -------------------- | ---------------------------------------------------------- | ------------------------------------------- | -------------------------------- |
| イベント一覧取得     | ListEventsQuery      | ユーザーが閲覧可能なイベントを一覧取得する。               | { Page, PageSize, StatusFilter, TagFilter } | PaginatedResult<EventSummaryDTO> |
| イベント詳細取得     | GetEventDetailsQuery | 単一イベントの完全な詳細情報を取得する。                   | { EventID }                                 | EventDetailsDTO                  |
| マイイベント一覧取得 | ListMyEventsQuery    | 自分が参加登録した、または作成したイベントを一覧取得する。 | { Page, PageSize }                          | PaginatedResult<EventSummaryDTO> |
